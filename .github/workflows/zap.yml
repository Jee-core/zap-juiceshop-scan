name: Juice Shop Security Scan

on:
  workflow_dispatch:

jobs:
  security_scan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Start Juice Shop
      run: |
        docker run -d --name juiceshop -p 3000:3000 bkimminich/juice-shop
        echo "Waiting for Juice Shop..."
        # Wait with timeout and checks
        for i in {1..30}; do
          if curl -s http://localhost:3000 > /dev/null; then
            echo "✅ Juice Shop ready after $((i*2)) seconds"
            break
          fi
          echo "⏳ Waiting... ($i/30)"
          sleep 2
        done

    - name: Run ZAP Baseline Scan
      uses: zaproxy/action-baseline-scan@v0.9.0
      with:
        target: 'http://localhost:3000'
        cmd_options: '-m 5 -I'
        rules_file_name: '.zap/rules.tsv'
        fail_action: false

    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report.html

    - name: Cleanup
      if: always()
      run: docker rm -f juiceshop || true